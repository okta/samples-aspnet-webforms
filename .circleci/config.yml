# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  windows: circleci/windows@5.0
  general-platform-helpers: okta/general-platform-helpers@1.9
  platform-helpers: okta/platform-helpers@1
  python: circleci/python@2.0.3
  aws-cli: circleci/aws-cli@5.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    executor:
      name: windows/default
    steps:
      - checkout
      - run: dotnet --version

      - run:
          name: build okta-hosted-login to scan
          command: ./okta-hosted-login/build.sh

      - run:
          name: build self-hosted-login to scan
          command: ./self-hosted-login/build.sh

      - run:
          name: build social-login to scan
          command: ./social-login/build.sh

      - persist_to_workspace:
          root: ~/project
          paths:
            - src
            - .git
            # Persist the entire subdirectories, ensuring all relevant files are available
            - okta-hosted-login
            - self-hosted-login
            - social-login

      - run:
          name: Install Python
          command: |
            choco install python --version=3.9.0 -y
            python --version
            python -m pip install --upgrade pip

      - run:
          name: Download Reverse Labs Scanner
          command: |
            curl.exe https://dso-resources.oktasecurity.com/scanner  -H "x-api-key: $env:DSO_RLSECURE_TOKEN" -o rl_wrapper-0.0.2+35ababa-py3-none-any.whl
      - run:
          name: Install RL Wrapper
          command: |
            pip install ./rl_wrapper-0.0.2+35ababa-py3-none-any.whl

  reversinglabs-scan:
    docker:
      - image: cimg/python:3.10
    steps:
      - run:
          command: >
            echo "export ARTIFACT_DIR=$(echo
            "${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}/path/to/my/directory")" >>
            "$BASH_ENV"

            echo "export ARTIFACT_COMMIT=$(echo "${CIRCLE_SHA1:0:8}")" >>
            "$BASH_ENV"

            source "$BASH_ENV"
          name: Set environment variables
      - platform-helpers/step-reversinglabs-scan:
          artifact-commit: $ARTIFACT_COMMIT
          artifact-dir: $ARTIFACT_DIR
          artifact-name: my-artifact-name

  snyk-scan:
    docker:
      - image: cimg/python:3.10
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: List Workspace Contents (Root)
          command: ls -al ~/project
      - run:
          name: List Workspace Contents (okta-hosted-login)
          command: ls -al ~/project/okta-hosted-login
      - run:
          name: List Workspace Contents (self-hosted-login)
          command: ls -al ~/project/self-hosted-login
      - run:
          name: List Workspace Contents (social-login)
          command: ls -al ~/project/social-login
      - general-platform-helpers/step-load-dependencies
      - run:
          name: Run Snyk Scans (Individual Projects)
          command: |
            cd ~/project/okta-hosted-login
            snyk monitor --severity-threshold=low
            cd ~/project/self-hosted-login
            snyk monitor --severity-threshold=low
            cd ~/project/social-login
            snyk monitor --severity-threshold=low

workflows:
  "Circle CI Tests":
    jobs:
      - build:
          context:
            - static-analysis
      - snyk-scan:
          name: execute-snyk
          context:
            - static-analysis
          requires:
            - build